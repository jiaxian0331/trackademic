<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trackademic</title>
    
    <!-- PyScript CSS and JS -->
    <link rel="stylesheet" href="https://pyscript.net/releases/2024.11.1/core.css">
    <script type="module" src="https://pyscript.net/releases/2024.11.1/core.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
        
        .container {
            width: 100%;
            max-width: 1200px;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        
        header {
            background: linear-gradient(135deg, #2c3e50, #4a6491);
            color: white;
            padding: 20px;
            text-align: center;
        }
        
        h1 {
            font-size: 28px;
            margin-bottom: 5px;
        }
        
        h2 {
            font-size: 22px;
            margin: 25px 0 15px;
            padding: 0 20px 10px;
            border-bottom: 2px solid #eaeaea;
            color: #2c3e50;
        }
        
        table {
            width: calc(100% - 40px);
            margin: 0 20px 20px;
            border-collapse: collapse;
        }
        
        th {
            background-color: #f8f9fa;
            padding: 12px 15px;
            text-align: left;
            font-weight: 600;
            color: #2c3e50;
            border-bottom: 2px solid #eaeaea;
        }
        
        td {
            padding: 12px 15px;
            border-bottom: 1px solid #eaeaea;
        }
        
        tr:last-child td {
            border-bottom: none;
        }
        
        .subject-name {
            font-weight: 600;
        }
        
        .subject-code {
            color: #666;
            font-family: monospace;
            font-size: 0.9em;
        }
        
        .credit-hours, .grade-select, .grade-points {
            font-weight: 600;
            text-align: center;
        }
        
        .grade-select select {
            width: 80px;
            padding: 6px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            background-color: #f8f9fa;
        }
        
        select, input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 100%;
            font-size: 14px;
        }
        
        .action-btn {
            background: none;
            border: none;
            color: #666;
            cursor: pointer;
            font-size: 18px;
            padding: 5px;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            transition: background-color 0.2s;
        }
        
        .action-btn:hover {
            background-color: #f0f0f0;
        }
        
        .trimester-selector {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin: 0 20px;
            padding: 10px 0;
        }
        
        .trimester-label {
            font-size: 22px;
            font-weight: 600;
            color: #2c3e50;
        }
        
        .trimester-dropdown {
            width: 200px;
            font-size: 16px;
            font-weight: 600;
            color: #2c3e50;
            background-color: #f8f9fa;
            border: 2px solid #ddd;
        }
        
        .add-subject-container {
            display: flex;
            justify-content: space-between;
            margin: 0 20px 30px;
            gap: 15px;
            align-items: center;
        }
        
        .subject-select {
            flex: 1;
        }
        
        .add-btn {
            background-color: #f8f9fa;
            color: #333;
            border: 1px solid #ddd;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
            white-space: nowrap;
        }
        
        .add-btn:hover {
            background-color: #e9ecef;
            border-color: #ccc;
        }
        
        .add-btn:disabled {
            background-color: #f8f9fa;
            color: #999;
            cursor: not-allowed;
            border-color: #eee;
        }
        
        .results-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 8px;
        }
        
        .result-box {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            text-align: center;
        }
        
        .result-label {
            font-size: 14px;
            color: #7f8c8d;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .result-value {
            font-size: 32px;
            font-weight: bold;
            color: #2c3e50;
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
            margin: 20px;
            justify-content: center;
        }
        
        .save-btn {
            background-color: #f8f9fa;
            color: #333;
            border: 1px solid #ddd;
            padding: 12px 25px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .save-btn:hover {
            background-color: #e9ecef;
            border-color: #ccc;
        }
        
        .save-btn:disabled {
            background-color: #f8f9fa;
            color: #999;
            cursor: not-allowed;
            border-color: #eee;
        }
        
        .reset-btn {
            background-color: #f8f9fa;
            color: #333;
            border: 1px solid #ddd;
            padding: 12px 25px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .reset-btn:hover {
            background-color: #e9ecef;
            border-color: #ccc;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #7f8c8d;
            margin: 0 20px;
        }
        
        .error {
            text-align: center;
            padding: 20px;
            color: #666;
            background-color: #f8f9fa;
            margin: 0 20px 20px;
            border-radius: 4px;
            border: 1px solid #eee;
        }
        
        .info-message {
            text-align: center;
            padding: 15px;
            color: #7f8c8d;
            background-color: #f8f9fa;
            margin: 0 20px;
            border-radius: 4px;
            font-size: 14px;
            border-left: 3px solid #ddd;
        }
        
        .cgpa-history {
            margin: 20px;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 10px;
        }
        
        .cgpa-summary {
            margin: 0 20px 20px;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 8px;
        }
        
        .history-item {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            border-bottom: 1px solid #eaeaea;
        }
        
        .history-item:last-child {
            border-bottom: none;
        }
        
        @media (max-width: 768px) {
            table {
                display: block;
                overflow-x: auto;
            }
            
            th, td {
                white-space: nowrap;
            }
            
            .trimester-selector {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            .trimester-dropdown {
                width: 100%;
            }
            
            .add-subject-container {
                flex-direction: column;
            }
            
            .results-container {
                grid-template-columns: 1fr;
            }
            
            .action-buttons {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Calculator Trackademic</h1>
        </header>
        
        <!-- Trimester Selector Section -->
        <div class="trimester-selector">
            <div class="trimester-label">Current Trimester:</div>
            <select id="trimester-select" class="trimester-dropdown">
                <option value="1">Trimester 1</option>
                <option value="2">Trimester 2</option>
                <option value="3">Trimester 3</option>
                <option value="4">Trimester 4</option>
                <option value="5">Trimester 5</option>
                <option value="6">Trimester 6</option>
            </select>
        </div>
        
        <div class="add-subject-container">
            <select id="subject-select" class="subject-select">
                <option value="">Select a subject to add...</option>
            </select>
            <button class="add-btn" id="add-subject-btn" disabled>+ Add Subject</button>
        </div>
        
        <table>
            <thead>
                <tr>
                    <th>Subject Name</th>
                    <th>Subject Code</th>
                    <th>Credit Hours</th>
                    <th>Grade</th>
                    <th>Grade Points</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody id="subjects-tbody">
                <!-- Subjects will be loaded here dynamically -->
            </tbody>
        </table>
        
        <div id="loading-message" class="loading">Loading subjects from database...</div>
        <div id="error-message" class="error" style="display: none;"></div>
        
        <!-- Real-time GPA Display -->
        <div class="results-container">
            <div class="result-box" id="gpa-box">
                <div class="result-label">GPA (Current Trimester)</div>
                <div class="result-value" id="gpa-result">0.00</div>
            </div>
        </div>
        
        <div class="action-buttons">
            <button class="save-btn" id="save-cgpa-btn" disabled>
                Save Trimester
            </button>
            <button class="reset-btn" id="reset-btn">
                Reset Trimester
            </button>
            <button class="reset-btn" id="clear-history-btn">
                Clear All History
            </button>
        </div>
        
        <h2>CGPA History</h2>
        <div class="cgpa-history" id="cgpa-history">
            <div class="history-item" style="color: #7f8c8d; font-style: italic;">
                No CGPA history yet. Save your first trimester to start tracking.
            </div>
        </div>
        
        <div class="cgpa-summary">
            <div class="result-label">CGPA</div>
            <div class="result-value" id="cgpa-result">0.00</div>
        </div>
    </div>

    <!-- PyScript Python Code -->
    <py-script>
        import asyncio
        import json
        from js import document, console, alert, confirm, localStorage, fetch
        from pyodide.ffi import create_proxy
        
        # Constants
        API_BASE_URL = 'http://localhost:5000'
        
        # Global variables
        all_subjects = []
        added_subject_ids = set()
        current_subjects = []
        cgpa_history = []
        
        # Grade mapping
        grade_scale = {
            'A+': 4.00,
            'A': 4.00,
            'A-': 3.67,
            'B+': 3.33,
            'B': 3.00,
            'B-': 2.67,
            'C+': 2.33,
            'C': 2.00,
            'C-': 1.67,
            'D+': 1.33,
            'D': 1.00,
            'F': 0.00
        }
        
        # Get DOM elements
        trimester_select = document.getElementById('trimester-select')
        subject_select = document.getElementById('subject-select')
        add_subject_btn = document.getElementById('add-subject-btn')
        subjects_tbody = document.getElementById('subjects-tbody')
        loading_message = document.getElementById('loading-message')
        error_message = document.getElementById('error-message')
        save_cgpa_btn = document.getElementById('save-cgpa-btn')
        reset_btn = document.getElementById('reset-btn')
        clear_history_btn = document.getElementById('clear-history-btn')
        gpa_result_el = document.getElementById('gpa-result')
        cgpa_result_el = document.getElementById('cgpa-result')
        cgpa_history_el = document.getElementById('cgpa-history')
        
        # Initialize the application
        async def initialize():
            await load_all_subjects()
            initialize_fresh_state()
            setup_event_listeners()
            calculate_and_display_gpa()
        
        # Set up event listeners
        def setup_event_listeners():
            def on_subject_select_change(event):
                add_subject_btn.disabled = not subject_select.value
            
            def on_trimester_select_change(event):
                console.log(f"Switched to Trimester {trimester_select.value}")
                reset_trimester()
            
            def on_add_subject_click(event):
                add_selected_subject()
            
            def on_save_cgpa_click(event):
                save_to_cgpa_history()
            
            def on_reset_click(event):
                reset_trimester()
            
            def on_clear_history_click(event):
                clear_all_history()
            
            # Create proxies for Python functions to be called from JS
            subject_select.addEventListener('change', create_proxy(on_subject_select_change))
            trimester_select.addEventListener('change', create_proxy(on_trimester_select_change))
            add_subject_btn.addEventListener('click', create_proxy(on_add_subject_click))
            save_cgpa_btn.addEventListener('click', create_proxy(on_save_cgpa_click))
            reset_btn.addEventListener('click', create_proxy(on_reset_click))
            clear_history_btn.addEventListener('click', create_proxy(on_clear_history_click))
        
        # Initialize fresh state
        def initialize_fresh_state():
            localStorage.removeItem('cgpaHistory')
            cgpa_history.clear()
            update_cgpa_history_display()
            calculate_cgpa()
            console.log('Started with fresh state - no previous history loaded')
        
        # Load all subjects from API
        async def load_all_subjects():
            try:
                response = await fetch(f"{API_BASE_URL}/api/subjects")
                if not response.ok:
                    raise Exception('Failed to load subjects from database')
                
                data = await response.json()
                
                if data.get('success'):
                    all_subjects.clear()
                    all_subjects.extend(data.get('subjects', []))
                    populate_subject_select()
                    loading_message.style.display = 'none'
                    console.log(f"Loaded {len(all_subjects)} subjects from database")
                else:
                    raise Exception(data.get('error', 'Failed to load subjects'))
            except Exception as e:
                console.error('Error loading subjects:', e)
                show_error(f"Error loading subjects: {str(e)}. Please make sure the backend server is running at http://localhost:5000")
                loading_message.textContent = 'Failed to load subjects from database. Check if Flask server is running.'
        
        # Populate subject select dropdown
        def populate_subject_select():
            subject_select.innerHTML = '<option value="">Select a subject to add...</option>'
            
            if len(all_subjects) == 0:
                option = document.createElement('option')
                option.value = ''
                option.textContent = 'No subjects available. Please add subjects to database.'
                subject_select.appendChild(option)
                return
            
            for subject in all_subjects:
                option = document.createElement('option')
                option.value = str(subject.get('id', ''))
                option.textContent = f"{subject.get('code', '')} - {subject.get('name', '')} ({subject.get('credits', 0)} credits)"
                option.dataset.subject = json.dumps(subject)
                subject_select.appendChild(option)
        
        # Add selected subject to table
        def add_selected_subject():
            selected_option = subject_select.options[subject_select.selectedIndex]
            if not selected_option.value:
                return
            
            subject = json.loads(selected_option.dataset.subject)
            subject_id = subject.get('id')
            
            # Check if subject already added
            if subject_id in added_subject_ids:
                alert('This subject has already been added to the trimester.')
                return
            
            add_subject_to_table(subject)
            added_subject_ids.add(subject_id)
            subject_select.value = ''
            add_subject_btn.disabled = True
        
        # Add subject to table
        def add_subject_to_table(subject):
            row = document.createElement('tr')
            subject_id = subject.get('id')
            row.dataset.subjectId = str(subject_id)
            row.dataset.credits = str(subject.get('credits', 0))
            
            grade_select_html = create_grade_select()
            
            row.innerHTML = f'''
                <td class="subject-name">{subject.get('name', '')}</td>
                <td class="subject-code">{subject.get('code', '')}</td>
                <td class="credit-hours">{subject.get('credits', 0)}</td>
                <td class="grade-select">{grade_select_html}</td>
                <td class="grade-points" id="grade-points-{subject_id}">0.00</td>
                <td>
                    <button class="action-btn" title="Delete subject">
                        ×
                    </button>
                </td>
            '''
            
            subjects_tbody.appendChild(row)
            
            # Track this subject
            subject_with_grade = {
                'id': subject_id,
                'name': subject.get('name', ''),
                'code': subject.get('code', ''),
                'credits': subject.get('credits', 0),
                'grade': '',
                'trimester': trimester_select.value
            }
            current_subjects.append(subject_with_grade)
            
            # Add event listener for grade selection
            grade_select_element = row.querySelector('.grade-select select')
            
            def on_grade_change(event):
                update_grade_points(subject_id, event.target.value)
                
                # Update the subject's grade in current_subjects array
                for subj in current_subjects:
                    if subj['id'] == subject_id:
                        subj['grade'] = event.target.value
                        break
                
                # Recalculate and update GPA display
                calculate_and_display_gpa()
            
            grade_select_element.addEventListener('change', create_proxy(on_grade_change))
            
            # Add delete functionality
            delete_btn = row.querySelector('.action-btn')
            
            def on_delete_click(event):
                subject_id_to_remove = int(row.dataset.subjectId)
                added_subject_ids.discard(subject_id_to_remove)
                
                # Remove from current_subjects array
                for i, subj in enumerate(current_subjects):
                    if subj['id'] == subject_id_to_remove:
                        current_subjects.pop(i)
                        break
                
                row.remove()
                calculate_and_display_gpa()
            
            delete_btn.addEventListener('click', create_proxy(on_delete_click))
        
        # Create grade select dropdown
        def create_grade_select():
            select = document.createElement('select')
            select.innerHTML = '<option value="">Select Grade</option>'
            
            for grade in grade_scale:
                option = document.createElement('option')
                option.value = grade
                option.textContent = grade
                select.appendChild(option)
            
            return select.outerHTML
        
        # Update grade points display
        def update_grade_points(subject_id, grade):
            grade_points = grade_scale.get(grade, 0)
            grade_points_el = document.getElementById(f'grade-points-{subject_id}')
            if grade_points_el:
                grade_points_el.textContent = f'{grade_points:.2f}'
        
        # Calculate and display GPA
        def calculate_and_display_gpa():
            gpa_data = calculate_gpa()
            update_gpa_display(gpa_data)
            return gpa_data
        
        # Calculate GPA
        def calculate_gpa():
            total_credits = 0
            total_grade_points = 0
            subjects_with_grades = 0
            subjects_without_grades = 0
            
            for subject in current_subjects:
                grade = subject.get('grade', '')
                credits = subject.get('credits', 0)
                
                if grade and grade in grade_scale:
                    grade_points = grade_scale[grade]
                    subject_grade_points = credits * grade_points
                    
                    total_credits += credits
                    total_grade_points += subject_grade_points
                    subjects_with_grades += 1
                else:
                    subjects_without_grades += 1
            
            gpa = (total_grade_points / total_credits) if total_credits > 0 else 0
            
            return {
                'totalCredits': total_credits,
                'totalGradePoints': total_grade_points,
                'gpa': gpa,
                'subjectsWithGrades': subjects_with_grades,
                'subjectsWithoutGrades': subjects_without_grades,
                'totalSubjects': len(current_subjects)
            }
        
        # Update GPA display
        def update_gpa_display(gpa_data):
            gpa = gpa_data.get('gpa', 0)
            subjects_without_grades = gpa_data.get('subjectsWithoutGrades', 0)
            total_subjects = gpa_data.get('totalSubjects', 0)
            
            # Update the GPA value
            gpa_result_el.textContent = f'{gpa:.2f}'
            
            # Enable/disable save button based on status
            if total_subjects == 0:
                save_cgpa_btn.disabled = True
            elif subjects_without_grades > 0:
                save_cgpa_btn.disabled = True
            else:
                save_cgpa_btn.disabled = False
        
        # Calculate CGPA
        def calculate_cgpa():
            if len(cgpa_history) == 0:
                cgpa_result_el.textContent = '0.00'
                return 0
            
            total_cumulative_credits = 0
            total_cumulative_grade_points = 0
            
            for semester in cgpa_history:
                total_cumulative_credits += semester.get('totalCredits', 0)
                total_cumulative_grade_points += semester.get('totalGradePoints', 0)
            
            cgpa = (total_cumulative_grade_points / total_cumulative_credits) if total_cumulative_credits > 0 else 0
            
            cgpa_result_el.textContent = f'{cgpa:.2f}'
            return cgpa
        
        # Save to CGPA history
        async def save_to_cgpa_history():
            current_semester = calculate_gpa()
            
            if current_semester.get('totalCredits') == 0:
                alert('Please add subjects before saving.')
                return
            
            # Check if any subject is missing a grade
            has_missing_grades = any(not subject.get('grade') for subject in current_subjects)
            
            if has_missing_grades:
                alert('Please select grades for all subjects before saving.')
                return
            
            # Get the current trimester number from dropdown
            trimester_number = trimester_select.value
            trimester_name = f'Trimester {trimester_number}'
            
            # Prepare data for database save
            save_data = {
                'trimester': trimester_name,
                'gpa': current_semester.get('gpa', 0),
                'trimesterNumber': trimester_number,
                'totalCredits': current_semester.get('totalCredits', 0),
                'totalGradePoints': current_semester.get('totalGradePoints', 0),
                'subjects': current_subjects
            }
            
            # Try to save to database
            try:
                response = await fetch(f"{API_BASE_URL}/api/save-trimester", {
                    'method': 'POST',
                    'headers': {
                        'Content-Type': 'application/json',
                    },
                    'body': json.dumps(save_data)
                })
                
                data = await response.json()
                
                if data.get('success'):
                    # Also save locally for immediate display
                    semester_data = {
                        'semester': trimester_name,
                        'trimesterNumber': trimester_number,
                        'date': new Date().toLocaleDateString(),
                        'totalCredits': current_semester.get('totalCredits', 0),
                        'totalGradePoints': current_semester.get('totalGradePoints', 0),
                        'gpa': current_semester.get('gpa', 0),
                        'subjects': current_subjects.copy()
                    }
                    
                    # Check if this trimester already exists in history
                    existing_index = next((i for i, item in enumerate(cgpa_history) 
                                         if item.get('trimesterNumber') == trimester_number), -1)
                    
                    if existing_index != -1:
                        # Update existing trimester
                        cgpa_history[existing_index] = semester_data
                    else:
                        # Add new trimester
                        cgpa_history.append(semester_data)
                    
                    # Sort by trimester number
                    cgpa_history.sort(key=lambda x: int(x.get('trimesterNumber', 0)))
                    
                    update_cgpa_history_display()
                    calculate_cgpa()
                    
                    # Show success message with GPA
                    alert(f"Trimester {trimester_number} saved successfully!\n\nGPA: {current_semester.get('gpa', 0):.2f}\nSubjects: {current_semester.get('totalSubjects', 0)}\nCredits: {current_semester.get('totalCredits', 0)}")
                    
                    # Reset for next trimester
                    # Auto-advance to next trimester if not the last one
                    if int(trimester_number) < 6:
                        next_trimester = int(trimester_number) + 1
                        trimester_select.value = str(next_trimester)
                        reset_trimester()
                    else:
                        reset_trimester()
                else:
                    alert('Failed to save to database: ' + data.get('error', 'Unknown error'))
            except Exception as e:
                console.error('Database save error:', e)
                
                # Fallback to localStorage
                semester_data = {
                    'semester': trimester_name,
                    'trimesterNumber': trimester_number,
                    'date': new Date().toLocaleDateString(),
                    'totalCredits': current_semester.get('totalCredits', 0),
                    'totalGradePoints': current_semester.get('totalGradePoints', 0),
                    'gpa': current_semester.get('gpa', 0),
                    'subjects': current_subjects.copy()
                }
                
                # Check if this trimester already exists in history
                existing_index = next((i for i, item in enumerate(cgpa_history) 
                                     if item.get('trimesterNumber') == trimester_number), -1)
                
                if existing_index != -1:
                    # Update existing trimester
                    cgpa_history[existing_index] = semester_data
                else:
                    # Add new trimester
                    cgpa_history.append(semester_data)
                
                # Sort by trimester number
                cgpa_history.sort(key=lambda x: int(x.get('trimesterNumber', 0)))
                
                update_cgpa_history_display()
                calculate_cgpa()
                
                # Show success message with GPA
                alert(f"Trimester {trimester_number} saved!\n\nGPA: {current_semester.get('gpa', 0):.2f}\nSubjects: {current_semester.get('totalSubjects', 0)}\nCredits: {current_semester.get('totalCredits', 0)}")
                
                # Reset for next trimester
                if int(trimester_number) < 6:
                    next_trimester = int(trimester_number) + 1
                    trimester_select.value = str(next_trimester)
                    reset_trimester()
                else:
                    reset_trimester()
        
        # Update CGPA history display
        def update_cgpa_history_display():
            cgpa_history_el.innerHTML = ''
            
            if len(cgpa_history) == 0:
                empty_msg = document.createElement('div')
                empty_msg.className = 'history-item'
                empty_msg.style.color = '#7f8c8d'
                empty_msg.style.fontStyle = 'italic'
                empty_msg.textContent = 'No CGPA history yet. Save your first trimester to start tracking.'
                cgpa_history_el.appendChild(empty_msg)
                return
            
            for index, semester in enumerate(cgpa_history):
                history_item = document.createElement('div')
                history_item.className = 'history-item'
                
                semester_info = document.createElement('div')
                semester_info.innerHTML = f"""
                    <strong>{semester.get('semester', '')}</strong><br>
                    <small>{semester.get('date', '')}</small>
                """
                
                semester_grades = document.createElement('div')
                semester_grades.style.textAlign = 'right'
                semester_grades.innerHTML = f"""
                    <div style="font-weight: bold;">GPA: {semester.get('gpa', 0):.2f}</div>
                    <small>Credits: {semester.get('totalCredits', 'N/A')}</small><br>
                    <small>Subjects: {len(semester.get('subjects', [])) if semester.get('subjects') else 'N/A'}</small>
                """
                
                delete_btn = document.createElement('button')
                delete_btn.className = 'action-btn'
                delete_btn.innerHTML = '×'
                delete_btn.title = 'Remove from history'
                delete_btn.style.marginLeft = '10px'
                
                def make_delete_handler(idx):
                    def handler():
                        if confirm('Remove this trimester from history?'):
                            cgpa_history.pop(idx)
                            update_cgpa_history_display()
                            calculate_cgpa()
                    return handler
                
                delete_btn.addEventListener('click', create_proxy(make_delete_handler(index)))
                
                history_item.appendChild(semester_info)
                history_item.appendChild(semester_grades)
                history_item.appendChild(delete_btn)
                cgpa_history_el.appendChild(history_item)
        
        # Reset trimester
        def reset_trimester():
            if not confirm('Are you sure you want to reset the current trimester? This will remove all added subjects.'):
                return
            
            subjects_tbody.innerHTML = ''
            added_subject_ids.clear()
            current_subjects.clear()
            subject_select.value = ''
            add_subject_btn.disabled = True
            
            # Reset GPA display
            gpa_result_el.textContent = '0.00'
            save_cgpa_btn.disabled = True
        
        # Clear all history
        def clear_all_history():
            if not confirm('Are you sure you want to clear ALL CGPA history? This action cannot be undone.'):
                return
            
            # Clear localStorage
            localStorage.removeItem('cgpaHistory')
            
            # Clear cgpa_history array
            cgpa_history.clear()
            
            # Update displays
            update_cgpa_history_display()
            calculate_cgpa()
            
            alert('All CGPA history has been cleared.')
        
        # Show error message
        def show_error(message):
            error_message.textContent = message
            error_message.style.display = 'block'
        
        # Initialize the application
        asyncio.create_task(initialize())
    </py-script>
</body>
</html>